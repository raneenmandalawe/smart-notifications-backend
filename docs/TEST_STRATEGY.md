# Backend Test Strategy

## Goals
- Maintain a clean, **layered** testing approach aligned with the course.
- Keep tests deterministic and stable.
- Use **real ERPNext** only in integration tests.
- Provide clear reports and CI signals.

## Test Pyramid
1) **Unit** (fast, isolated)
2) **API** (contract checks with TestClient)
3) **Integration** (real ERPNext, seeded data)

## Scope by Layer (MVC Mapping)
- **Controllers/Routes (View/Controller)** → API tests
- **Services (Business Logic)** → Unit tests
- **Repositories (Model/Data)** → Integration tests

## What Is Mocked vs Real
- **Unit tests**: No network/ERPNext calls; pure logic only.
- **API tests**: Mock service/controller behavior where needed; verify contract/shape only.
- **Integration tests**: Real ERPNext data via a deterministic seed script; no mocks.

## Determinism Rules
- Time is controlled via a shared `utcnow()` helper (monkeypatched in tests).
- Seeded ERPNext data uses fixed tags and predictable inputs.

## Success Criteria
- Unit tests cover risk logic, store behavior, and merge logic.
- API tests validate status codes and response schema only.
- Integration tests validate real business scenarios:
	- Seed data created
	- `/scan` returns expected HIGH risk + channels
	- `/dashboard` reflects persisted results

## Reporting & Artifacts
- `allure-results/` generated by pytest.
- CI uploads Allure results and coverage report.

## Execution Matrix
- **CI (PR)**: unit + API tests, coverage, Allure artifacts.
- **Manual**: integration tests with ERPNext credentials.
